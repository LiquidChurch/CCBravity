define(["jquery","./options","./utils","./keys"],function(e,c,d,a){var b=function(k,n){if(k.data("select2")!=null){k.data("select2").destroy()}this.$element=k;this.id=this._generateId(k);n=n||{};this.options=new c(n,k);b.__super__.constructor.call(this);var i=k.attr("tabindex")||0;k.data("old-tabindex",i);k.attr("tabindex","-1");var h=this.options.get("dataAdapter");this.dataAdapter=new h(k,this.options);var m=this.render();this._placeContainer(m);var j=this.options.get("selectionAdapter");this.selection=new j(k,this.options);this.$selection=this.selection.render();this.selection.position(this.$selection,m);var f=this.options.get("dropdownAdapter");this.dropdown=new f(k,this.options);this.$dropdown=this.dropdown.render();this.dropdown.position(this.$dropdown,m);var g=this.options.get("resultsAdapter");this.results=new g(k,this.options,this.dataAdapter);this.$results=this.results.render();this.results.position(this.$results,this.$dropdown);var l=this;this._bindAdapters();this._registerDomEvents();this._registerDataEvents();this._registerSelectionEvents();this._registerDropdownEvents();this._registerResultsEvents();this._registerEvents();this.dataAdapter.current(function(o){l.trigger("selection:update",{data:o})});k.addClass("select2-hidden-accessible");k.attr("aria-hidden","true");this._syncAttributes();k.data("select2",this)};d.Extend(b,d.Observable);b.prototype._generateId=function(f){var g="";if(f.attr("id")!=null){g=f.attr("id")}else{if(f.attr("name")!=null){g=f.attr("name")+"-"+d.generateChars(2)}else{g=d.generateChars(4)}}g=g.replace(/(:|\.|\[|\]|,)/g,"");g="select2-"+g;return g};b.prototype._placeContainer=function(g){g.insertAfter(this.$element);var f=this._resolveWidth(this.$element,this.options.get("width"));if(f!=null){g.css("width",f)}};b.prototype._resolveWidth=function(r,f){var p=/^width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/i;if(f=="resolve"){var j=this._resolveWidth(r,"style");if(j!=null){return j}return this._resolveWidth(r,"element")}if(f=="element"){var o=r.outerWidth(false);if(o<=0){return"auto"}return o+"px"}if(f=="style"){var g=r.attr("style");if(typeof(g)!=="string"){return null}var q=g.split(";");for(var k=0,h=q.length;k<h;k=k+1){var n=q[k].replace(/\s/g,"");var m=n.match(p);if(m!==null&&m.length>=1){return m[1]}}return null}return f};b.prototype._bindAdapters=function(){this.dataAdapter.bind(this,this.$container);this.selection.bind(this,this.$container);this.dropdown.bind(this,this.$container);this.results.bind(this,this.$container)};b.prototype._registerDomEvents=function(){var g=this;this.$element.on("change.select2",function(){g.dataAdapter.current(function(h){g.trigger("selection:update",{data:h})})});this.$element.on("focus.select2",function(h){g.trigger("focus",h)});this._syncA=d.bind(this._syncAttributes,this);this._syncS=d.bind(this._syncSubtree,this);if(this.$element[0].attachEvent){this.$element[0].attachEvent("onpropertychange",this._syncA)}var f=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;if(f!=null){this._observer=new f(function(h){e.each(h,g._syncA);e.each(h,g._syncS)});this._observer.observe(this.$element[0],{attributes:true,childList:true,subtree:false})}else{if(this.$element[0].addEventListener){this.$element[0].addEventListener("DOMAttrModified",g._syncA,false);this.$element[0].addEventListener("DOMNodeInserted",g._syncS,false);this.$element[0].addEventListener("DOMNodeRemoved",g._syncS,false)}}};b.prototype._registerDataEvents=function(){var f=this;this.dataAdapter.on("*",function(g,h){f.trigger(g,h)})};b.prototype._registerSelectionEvents=function(){var f=this;var g=["toggle","focus"];this.selection.on("toggle",function(){f.toggleDropdown()});this.selection.on("focus",function(h){f.focus(h)});this.selection.on("*",function(h,i){if(e.inArray(h,g)!==-1){return}f.trigger(h,i)})};b.prototype._registerDropdownEvents=function(){var f=this;this.dropdown.on("*",function(g,h){f.trigger(g,h)})};b.prototype._registerResultsEvents=function(){var f=this;this.results.on("*",function(g,h){f.trigger(g,h)})};b.prototype._registerEvents=function(){var f=this;this.on("open",function(){f.$container.addClass("select2-container--open")});this.on("close",function(){f.$container.removeClass("select2-container--open")});this.on("enable",function(){f.$container.removeClass("select2-container--disabled")});this.on("disable",function(){f.$container.addClass("select2-container--disabled")});this.on("blur",function(){f.$container.removeClass("select2-container--focus")});this.on("query",function(g){if(!f.isOpen()){f.trigger("open",{})}this.dataAdapter.query(g,function(h){f.trigger("results:all",{data:h,query:g})})});this.on("query:append",function(g){this.dataAdapter.query(g,function(h){f.trigger("results:append",{data:h,query:g})})});this.on("keypress",function(g){var h=g.which;if(f.isOpen()){if(h===a.ESC||h===a.TAB||(h===a.UP&&g.altKey)){f.close();g.preventDefault()}else{if(h===a.ENTER){f.trigger("results:select",{});g.preventDefault()}else{if((h===a.SPACE&&g.ctrlKey)){f.trigger("results:toggle",{});g.preventDefault()}else{if(h===a.UP){f.trigger("results:previous",{});g.preventDefault()}else{if(h===a.DOWN){f.trigger("results:next",{});g.preventDefault()}}}}}}else{if(h===a.ENTER||h===a.SPACE||(h===a.DOWN&&g.altKey)){f.open();g.preventDefault()}}})};b.prototype._syncAttributes=function(){this.options.set("disabled",this.$element.prop("disabled"));if(this.options.get("disabled")){if(this.isOpen()){this.close()}this.trigger("disable",{})}else{this.trigger("enable",{})}};b.prototype._syncSubtree=function(g,f){var j=false;var h=this;if(g&&g.target&&(g.target.nodeName!=="OPTION"&&g.target.nodeName!=="OPTGROUP")){return}if(!f){j=true}else{if(f.addedNodes&&f.addedNodes.length>0){for(var k=0;k<f.addedNodes.length;k++){var i=f.addedNodes[k];if(i.selected){j=true}}}else{if(f.removedNodes&&f.removedNodes.length>0){j=true}}}if(j){this.dataAdapter.current(function(l){h.trigger("selection:update",{data:l})})}};b.prototype.trigger=function(i,h){var j=b.__super__.trigger;var k={open:"opening",close:"closing",select:"selecting",unselect:"unselecting"};if(h===undefined){h={}}if(i in k){var g=k[i];var f={prevented:false,name:i,args:h};j.call(this,g,f);if(f.prevented){h.prevented=true;return}}j.call(this,i,h)};b.prototype.toggleDropdown=function(){if(this.options.get("disabled")){return}if(this.isOpen()){this.close()}else{this.open()}};b.prototype.open=function(){if(this.isOpen()){return}this.trigger("query",{})};b.prototype.close=function(){if(!this.isOpen()){return}this.trigger("close",{})};b.prototype.isOpen=function(){return this.$container.hasClass("select2-container--open")};b.prototype.hasFocus=function(){return this.$container.hasClass("select2-container--focus")};b.prototype.focus=function(f){if(this.hasFocus()){return}this.$container.addClass("select2-container--focus");this.trigger("focus",{})};b.prototype.enable=function(f){if(this.options.get("debug")&&window.console&&console.warn){console.warn('Select2: The `select2("enable")` method has been deprecated and will be removed in later Select2 versions. Use $element.prop("disabled") instead.')}if(f==null||f.length===0){f=[true]}var g=!f[0];this.$element.prop("disabled",g)};b.prototype.data=function(){if(this.options.get("debug")&&arguments.length>0&&window.console&&console.warn){console.warn('Select2: Data can no longer be set using `select2("data")`. You should consider setting the value instead using `$element.val()`.')}var f=[];this.dataAdapter.current(function(g){f=g});return f};b.prototype.val=function(g){if(this.options.get("debug")&&window.console&&console.warn){console.warn('Select2: The `select2("val")` method has been deprecated and will be removed in later Select2 versions. Use $element.val() instead.')}if(g==null||g.length===0){return this.$element.val()}var f=g[0];if(e.isArray(f)){f=e.map(f,function(h){return h.toString()})}this.$element.val(f).trigger("change")};b.prototype.destroy=function(){this.$container.remove();if(this.$element[0].detachEvent){this.$element[0].detachEvent("onpropertychange",this._syncA)}if(this._observer!=null){this._observer.disconnect();this._observer=null}else{if(this.$element[0].removeEventListener){this.$element[0].removeEventListener("DOMAttrModified",this._syncA,false);this.$element[0].removeEventListener("DOMNodeInserted",this._syncS,false);this.$element[0].removeEventListener("DOMNodeRemoved",this._syncS,false)}}this._syncA=null;this._syncS=null;this.$element.off(".select2");this.$element.attr("tabindex",this.$element.data("old-tabindex"));this.$element.removeClass("select2-hidden-accessible");this.$element.attr("aria-hidden","false");this.$element.removeData("select2");this.dataAdapter.destroy();this.selection.destroy();this.dropdown.destroy();this.results.destroy();this.dataAdapter=null;this.selection=null;this.dropdown=null;this.results=null};b.prototype.render=function(){var f=e('<span class="select2 select2-container"><span class="selection"></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>');f.attr("dir",this.options.get("dir"));this.$container=f;this.$container.addClass("select2-container--"+this.options.get("theme"));f.data("element",this.$element);return f};return b});