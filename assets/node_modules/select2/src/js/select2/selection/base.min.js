define(["jquery","../utils","../keys"],function(d,c,a){function b(e,f){this.$element=e;this.options=f;b.__super__.constructor.call(this)}c.Extend(b,c.Observable);b.prototype.render=function(){var e=d('<span class="select2-selection" role="combobox"  aria-haspopup="true" aria-expanded="false"></span>');this._tabindex=0;if(this.$element.data("old-tabindex")!=null){this._tabindex=this.$element.data("old-tabindex")}else{if(this.$element.attr("tabindex")!=null){this._tabindex=this.$element.attr("tabindex")}}e.attr("title",this.$element.attr("title"));e.attr("tabindex",this._tabindex);this.$selection=e;return e};b.prototype.bind=function(e,h){var g=this;var i=e.id+"-container";var f=e.id+"-results";this.container=e;this.$selection.on("focus",function(j){g.trigger("focus",j)});this.$selection.on("blur",function(j){g._handleBlur(j)});this.$selection.on("keydown",function(j){g.trigger("keypress",j);if(j.which===a.SPACE){j.preventDefault()}});e.on("results:focus",function(j){g.$selection.attr("aria-activedescendant",j.data._resultId)});e.on("selection:update",function(j){g.update(j.data)});e.on("open",function(){g.$selection.attr("aria-expanded","true");g.$selection.attr("aria-owns",f);g._attachCloseHandler(e)});e.on("close",function(){g.$selection.attr("aria-expanded","false");g.$selection.removeAttr("aria-activedescendant");g.$selection.removeAttr("aria-owns");g.$selection.focus();g._detachCloseHandler(e)});e.on("enable",function(){g.$selection.attr("tabindex",g._tabindex)});e.on("disable",function(){g.$selection.attr("tabindex","-1")})};b.prototype._handleBlur=function(e){var f=this;window.setTimeout(function(){if((document.activeElement==f.$selection[0])||(d.contains(f.$selection[0],document.activeElement))){return}f.trigger("blur",e)},1)};b.prototype._attachCloseHandler=function(e){var f=this;d(document.body).on("mousedown.select2."+e.id,function(j){var g=d(j.target);var h=g.closest(".select2");var i=d(".select2.select2-container--open");i.each(function(){var l=d(this);if(this==h[0]){return}var k=l.data("element");k.select2("close")})})};b.prototype._detachCloseHandler=function(e){d(document.body).off("mousedown.select2."+e.id)};b.prototype.position=function(e,g){var f=g.find(".selection");f.append(e)};b.prototype.destroy=function(){this._detachCloseHandler(this.container)};b.prototype.update=function(e){throw new Error("The `update` method must be defined in child classes.")};return b});