define(["jquery","./utils"],function(c,b){function a(d,e,f){this.$element=d;this.data=f;this.options=e;a.__super__.constructor.call(this)}b.Extend(a,b.Observable);a.prototype.render=function(){var d=c('<ul class="select2-results__options" role="tree"></ul>');if(this.options.get("multiple")){d.attr("aria-multiselectable","true")}this.$results=d;return d};a.prototype.clear=function(){this.$results.empty()};a.prototype.displayMessage=function(g){var d=this.options.get("escapeMarkup");this.clear();this.hideLoading();var e=c('<li role="treeitem" aria-live="assertive" class="select2-results__option"></li>');var f=this.options.get("translations").get(g.message);e.append(d(f(g.args)));e[0].className+=" select2-results__message";this.$results.append(e)};a.prototype.hideMessages=function(){this.$results.find(".select2-results__message").remove()};a.prototype.append=function(g){this.hideLoading();var e=[];if(g.results==null||g.results.length===0){if(this.$results.children().length===0){this.trigger("results:message",{message:"noResults"})}return}g.results=this.sort(g.results);for(var i=0;i<g.results.length;i++){var f=g.results[i];var h=this.option(f);e.push(h)}this.$results.append(e)};a.prototype.position=function(d,e){var f=e.find(".select2-results");f.append(d)};a.prototype.sort=function(d){var e=this.options.get("sorter");return e(d)};a.prototype.highlightFirstItem=function(){var d=this.$results.find(".select2-results__option[aria-selected]");var e=d.filter("[aria-selected=true]");if(e.length>0){e.first().trigger("mouseenter")}else{d.first().trigger("mouseenter")}this.ensureHighlightVisible()};a.prototype.setClasses=function(){var d=this;this.data.current(function(g){var f=c.map(g,function(h){return h.id.toString()});var e=d.$results.find(".select2-results__option[aria-selected]");e.each(function(){var i=c(this);var h=c.data(this,"data");var j=""+h.id;if((h.element!=null&&h.element.selected)||(h.element==null&&c.inArray(j,f)>-1)){i.attr("aria-selected","true")}else{i.attr("aria-selected","false")}})})};a.prototype.showLoading=function(f){this.hideLoading();var e=this.options.get("translations").get("searching");var g={disabled:true,loading:true,text:e(f)};var d=this.option(g);d.className+=" loading-results";this.$results.prepend(d)};a.prototype.hideLoading=function(){this.$results.find(".loading-results").remove()};a.prototype.option=function(h){var i=document.createElement("li");i.className="select2-results__option";var p={role:"treeitem","aria-selected":"false"};if(h.disabled){delete p["aria-selected"];p["aria-disabled"]="true"}if(h.id==null){delete p["aria-selected"]}if(h._resultId!=null){i.id=h._resultId}if(h.title){i.title=h.title}if(h.children){p.role="group";p["aria-label"]=h.text;delete p["aria-selected"]}for(var j in p){var g=p[j];i.setAttribute(j,g)}if(h.children){var d=c(i);var n=document.createElement("strong");n.className="select2-results__group";var m=c(n);this.template(h,n);var o=[];for(var l=0;l<h.children.length;l++){var f=h.children[l];var e=this.option(f);o.push(e)}var k=c("<ul></ul>",{"class":"select2-results__options select2-results__options--nested"});k.append(o);d.append(n);d.append(k)}else{this.template(h,i)}c.data(i,"data",h);return i};a.prototype.bind=function(d,f){var e=this;var g=d.id+"-results";this.$results.attr("id",g);d.on("results:all",function(h){e.clear();e.append(h.data);if(d.isOpen()){e.setClasses();e.highlightFirstItem()}});d.on("results:append",function(h){e.append(h.data);if(d.isOpen()){e.setClasses()}});d.on("query",function(h){e.hideMessages();e.showLoading(h)});d.on("select",function(){if(!d.isOpen()){return}e.setClasses();e.highlightFirstItem()});d.on("unselect",function(){if(!d.isOpen()){return}e.setClasses();e.highlightFirstItem()});d.on("open",function(){e.$results.attr("aria-expanded","true");e.$results.attr("aria-hidden","false");e.setClasses();e.ensureHighlightVisible()});d.on("close",function(){e.$results.attr("aria-expanded","false");e.$results.attr("aria-hidden","true");e.$results.removeAttr("aria-activedescendant")});d.on("results:toggle",function(){var h=e.getHighlightedResults();if(h.length===0){return}h.trigger("mouseup")});d.on("results:select",function(){var h=e.getHighlightedResults();if(h.length===0){return}var i=h.data("data");if(h.attr("aria-selected")=="true"){e.trigger("close",{})}else{e.trigger("select",{data:i})}});d.on("results:previous",function(){var j=e.getHighlightedResults();var i=e.$results.find("[aria-selected]");var l=i.index(j);if(l===0){return}var h=l-1;if(j.length===0){h=0}var k=i.eq(h);k.trigger("mouseenter");var o=e.$results.offset().top;var n=k.offset().top;var m=e.$results.scrollTop()+(n-o);if(h===0){e.$results.scrollTop(0)}else{if(n-o<0){e.$results.scrollTop(m)}}});d.on("results:next",function(){var j=e.getHighlightedResults();var i=e.$results.find("[aria-selected]");var l=i.index(j);var h=l+1;if(h>=i.length){return}var k=i.eq(h);k.trigger("mouseenter");var o=e.$results.offset().top+e.$results.outerHeight(false);var n=k.offset().top+k.outerHeight(false);var m=e.$results.scrollTop()+n-o;if(h===0){e.$results.scrollTop(0)}else{if(n>o){e.$results.scrollTop(m)}}});d.on("results:focus",function(h){h.element.addClass("select2-results__option--highlighted")});d.on("results:message",function(h){e.displayMessage(h)});if(c.fn.mousewheel){this.$results.on("mousewheel",function(k){var j=e.$results.scrollTop();var h=e.$results.get(0).scrollHeight-j+k.deltaY;var l=k.deltaY>0&&j-k.deltaY<=0;var i=k.deltaY<0&&h<=e.$results.height();if(l){e.$results.scrollTop(0);k.preventDefault();k.stopPropagation()}else{if(i){e.$results.scrollTop(e.$results.get(0).scrollHeight-e.$results.height());k.preventDefault();k.stopPropagation()}}})}this.$results.on("mouseup",".select2-results__option[aria-selected]",function(h){var j=c(this);var i=j.data("data");if(j.attr("aria-selected")==="true"){if(e.options.get("multiple")){e.trigger("unselect",{originalEvent:h,data:i})}else{e.trigger("close",{})}return}e.trigger("select",{originalEvent:h,data:i})});this.$results.on("mouseenter",".select2-results__option[aria-selected]",function(h){var i=c(this).data("data");e.getHighlightedResults().removeClass("select2-results__option--highlighted");e.trigger("results:focus",{data:i,element:c(this)})})};a.prototype.getHighlightedResults=function(){var d=this.$results.find(".select2-results__option--highlighted");return d};a.prototype.destroy=function(){this.$results.remove()};a.prototype.ensureHighlightVisible=function(){var e=this.getHighlightedResults();if(e.length===0){return}var d=this.$results.find("[aria-selected]");var f=d.index(e);var i=this.$results.offset().top;var h=e.offset().top;var g=this.$results.scrollTop()+(h-i);var j=h-i;g-=e.outerHeight(false)*2;if(f<=2){this.$results.scrollTop(0)}else{if(j>this.$results.outerHeight()||j<0){this.$results.scrollTop(g)}}};a.prototype.template=function(e,f){var g=this.options.get("templateResult");var d=this.options.get("escapeMarkup");var h=g(e,f);if(h==null){f.style.display="none"}else{if(typeof h==="string"){f.innerHTML=d(h)}else{c(f).append(h)}}};return a});